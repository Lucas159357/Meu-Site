<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Página Principal - Barbearia Pedro Rodrigues</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
  <style>
    /* ... (todo o seu CSS permanece igual) ... */
    /* Por questão de espaço, não repito aqui, mas mantenha o seu CSS atual */
  </style>
</head>
<body>
  <header>
    <h2 class="titulo-barbearia">Barbearia Pedro Rodrigues</h2>
    <button class="perfil-btn" onclick="abrirPerfil()" title="Perfil">
      <i class="fa-solid fa-user"></i>
    </button>
  </header>
  <div class="container">
    <h1>Escolha seu serviço</h1>
    <!-- Caixa de seleção de barbeiro -->
    <label for="selectBarbeiro" style="display:block;margin-bottom:10px;text-align:left;">Barbeiro:</label>
    <select id="selectBarbeiro" required style="width:100%;padding:10px;border-radius:6px;margin-bottom:18px;">
      <option value="">Selecione o barbeiro</option>
      <!-- Opções adicionadas via JS -->
    </select>
    <!-- Serviços dinâmicos -->
    <div id="servicos-lista"></div>
    <div class="botoes">
      <button onclick="logout()">Sair</button>
      <button onclick="enviar()">Enviar</button>
    </div>
    <div id="mensagem"></div>
  </div>

  <!-- Modal do perfil -->
  <div class="modal" id="modalPerfil">
    <div class="modal-content">
      <button class="close-modal" onclick="fecharPerfil()" aria-label="Fechar">&times;</button>
      <h3>Perfil</h3>
      <div class="perfil-opcoes">
        <button onclick="abrirSolicitacoes()" style="background:#00c853;color:#222;font-weight:bold;"><i class="fa-solid fa-list"></i> Ver Solicitações</button>
      </div>
      <input type="password" id="novaSenha" placeholder="Nova senha" />
      <button onclick="alterarSenha()">Alterar senha</button>
      <div id="perfil-mensagem"></div>
    </div>
  </div>

  <!-- Modal de solicitações -->
  <div class="modal-solic" id="modalSolicitacoes">
    <div class="modal-solic-content">
      <button class="close-modal-solic" onclick="fecharSolicitacoes()" aria-label="Fechar">&times;</button>
      <h3>Minhas Solicitações</h3>
      <div id="lista-solicitacoes">
        <div style="text-align:center;color:#fff;">Carregando...</div>
      </div>
    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAY-Win6vQEHP1XR_fG3NOg0PAkNPAcxSg",
      authDomain: "banco-de-dados-bd2a6.firebaseapp.com",
      projectId: "banco-de-dados-bd2a6",
      appId: "1:859895156791:web",
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // Carregar barbeiros dinamicamente
    function carregarBarbeiros() {
      const select = document.getElementById('selectBarbeiro');
      select.innerHTML = '<option value="">Selecione o barbeiro</option>';
      db.collection('barbeiros').get().then(snapshot => {
        snapshot.forEach(doc => {
          const option = document.createElement('option');
          option.value = doc.id;
          option.textContent = doc.data().nome;
          select.appendChild(option);
        });
      });
    }

    // Carregar serviços dinamicamente
    let servicosFirestore = [];
    function carregarServicos() {
      const lista = document.getElementById('servicos-lista');
      lista.innerHTML = '';
      db.collection('servicos').get().then(snapshot => {
        servicosFirestore = [];
        snapshot.forEach((doc, idx) => {
          const s = doc.data();
          servicosFirestore.push({ id: doc.id, nome: s.nome, preco: s.preco });
          const div = document.createElement('div');
          div.className = 'servico';
          div.innerHTML = `
            <span class="icone-servico"><i class="fa-solid fa-scissors"></i></span>
            <div class="info-servico">
              <div class="nome-servico">${s.nome}</div>
              <div class="preco-servico">R$ ${s.preco},00</div>
            </div>
            <div class="checkbox-custom" id="check-${idx}" onclick="toggleServicoCheckbox(${idx}, event)">
              <i class="fa-solid fa-check"></i>
            </div>
          `;
          lista.appendChild(div);
        });
      });
    }

    // Controle de seleção dos serviços
    let servicosSelecionados = [];
    function toggleServicoCheckbox(idx, event) {
      event.stopPropagation();
      const checkbox = document.getElementById('check-' + idx);
      if (servicosSelecionados.includes(idx)) {
        servicosSelecionados = servicosSelecionados.filter(i => i !== idx);
        checkbox.classList.remove('checked');
        checkbox.parentElement.classList.remove('selected');
      } else {
        servicosSelecionados.push(idx);
        checkbox.classList.add('checked');
        checkbox.parentElement.classList.add('selected');
      }
    }

    // Ao clicar no serviço (área inteira), também seleciona
    document.addEventListener('click', function(e) {
      if (e.target.classList.contains('servico')) {
        const idx = Array.from(document.getElementById('servicos-lista').children).indexOf(e.target);
        toggleServicoCheckbox(idx, e);
      }
    });

    // Enviar solicitação
    function enviar() {
      const mensagem = document.getElementById("mensagem");
      const selectBarbeiro = document.getElementById('selectBarbeiro');
      const barbeiroId = selectBarbeiro.value;
      const barbeiroNome = selectBarbeiro.options[selectBarbeiro.selectedIndex]?.textContent || "";

      if (!barbeiroId) {
        mensagem.textContent = "Selecione o barbeiro!";
        mensagem.style.color = "#ff5252";
        return;
      }
      if (servicosSelecionados.length === 0) {
        mensagem.textContent = "Selecione pelo menos um serviço!";
        mensagem.style.color = "#ff5252";
        return;
      }

      const user = auth.currentUser;
      if (!user) {
        mensagem.textContent = "Usuário não autenticado.";
        mensagem.style.color = "#ff5252";
        return;
      }

      // Pega os serviços selecionados
      const selecionados = servicosSelecionados.map(idx => servicosFirestore[idx]);
      const valorTotal = selecionados.reduce((acc, s) => acc + s.preco, 0);

      const solicitacao = {
        barbeiroId: barbeiroId,
        barbeiro: barbeiroNome,
        email: user.email,
        servicos: selecionados.map(s => ({ nome: s.nome, preco: s.preco })),
        valorTotal: valorTotal,
        status: "pendente",
        dataCriacao: firebase.firestore.FieldValue.serverTimestamp()
      };

      db.collection("solicitacoes")
        .add(solicitacao)
        .then(() => {
          mensagem.textContent = "Solicitação enviada com sucesso!";
          mensagem.style.color = "#b2ff59";
          servicosSelecionados = [];
          carregarServicos(); // Limpa seleção visual
        })
        .catch((error) => {
          mensagem.textContent = "Erro ao enviar solicitação: " + error.message;
          mensagem.style.color = "#ff5252";
        });
    }

    // Modal perfil, senha e solicitações (igual ao seu código anterior)
    function abrirPerfil() {
      document.getElementById('modalPerfil').style.display = 'flex';
      document.getElementById('novaSenha').value = '';
      document.getElementById('perfil-mensagem').textContent = '';
    }
    function fecharPerfil() {
      document.getElementById('modalPerfil').style.display = 'none';
    }
    function alterarSenha() {
      const novaSenha = document.getElementById('novaSenha').value;
      const mensagem = document.getElementById('perfil-mensagem');
      if (novaSenha.length < 6) {
        mensagem.textContent = 'A senha deve ter pelo menos 6 caracteres.';
        mensagem.style.color = '#ff5252';
        return;
      }
      const user = auth.currentUser;
      user.updatePassword(novaSenha)
        .then(() => {
          mensagem.textContent = 'Senha alterada com sucesso!';
          mensagem.style.color = '#b2ff59';
        })
        .catch((error) => {
          mensagem.textContent = 'Erro: ' + error.message;
          mensagem.style.color = '#ff5252';
        });
    }
    function abrirSolicitacoes() {
      window.location.href = "solicitacoes.html";
    }
    function logout() {
      auth.signOut().then(() => {
        window.location.href = "index.html";
      });
    }

    // Inicialização ao carregar a página
    window.onload = function() {
      carregarBarbeiros();
      carregarServicos();
    };
  </script>
</body>
</html>
