<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Minhas Solicitações - Barbearia Pedro Rodrigues</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #222;
        color: #fff;
        margin: 0;
        padding: 0;
        display: flex;
        flex-direction: column;
        align-items: center;
        min-height: 100vh;
      }
      .container {
        background: #333;
        padding: 40px 30px;
        border-radius: 10px;
        margin-top: 40px;
        text-align: center;
        width: 400px;
        box-shadow: 0 0 10px #111;
        max-width: 98vw;
      }
      h1 {
        color: #00c853;
        margin-bottom: 30px;
        font-size: 1.5em;
        letter-spacing: 1px;
      }
      .solicitacoes-lista {
        margin-top: 20px;
        text-align: left;
      }
      .solicitacao-bloco {
        background: #444;
        border-radius: 8px;
        margin-bottom: 18px;
        padding: 16px 12px;
        box-shadow: 0 2px 8px #1118;
        font-size: 1.1em;
      }
      .solicitacao-barbeiro {
        color: #b2ff59;
        font-weight: bold;
        margin-bottom: 8px;
        font-size: 1.1em;
      }
      .solicitacao-item {
        border-top: 1px solid #444a;
        margin-top: 8px;
        padding-top: 8px;
        padding-bottom: 4px;
        cursor: pointer;
        transition: background 0.2s;
      }
      .solicitacao-item:hover {
        background: #555;
      }
      .solicitacao-servicos {
        margin: 4px 0 8px 0;
      }
      .solicitacao-status {
        color: #00c853;
        font-size: 1em;
        font-weight: bold;
      }
      .solicitacao-pendente {
        color: #ffeb3b;
      }
      .solicitacao-cancelado {
        color: #ff5252;
      }
      .solicitacao-concluido {
        color: #00c853;
      }
      .solicitacao-data {
        color: #aaa;
        font-size: 0.97em;
        margin-bottom: 2px;
      }
      .voltar-btn {
        background: #007acc;
        color: #fff;
        border: none;
        border-radius: 5px;
        padding: 10px 22px;
        font-size: 1em;
        margin-bottom: 25px;
        cursor: pointer;
        transition: background 0.2s;
        margin-top: 0;
      }
      .voltar-btn:hover {
        background: #005fa3;
      }
      /* Modal */
      .modal {
        display: none;
        position: fixed;
        z-index: 20;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.7);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background: #181818;
        padding: 28px 18px 18px 18px;
        border-radius: 16px;
        text-align: center;
        min-width: 300px;
        box-shadow: 0 0 15px #111;
        position: relative;
        width: 94vw;
        max-width: 340px;
      }
      .modal-title {
        color: #00c853;
        font-size: 1.3em;
        margin-bottom: 18px;
        margin-top: 0;
        font-weight: bold;
        letter-spacing: 0.5px;
      }
      .modal-content label {
        display: block;
        color: #00ff6a;
        text-align: left;
        margin-top: 12px;
        margin-bottom: 3px;
        font-size: 1em;
        font-weight: bold;
      }
      .modal-status-label {
        color: #00ff6a;
        text-align: left;
        font-size: 1em;
        font-weight: bold;
        margin-bottom: 2px;
      }
      .modal-status-value {
        background: #181818;
        color: #00ff6a;
        border-radius: 6px;
        padding: 8px 0;
        margin-bottom: 14px;
        font-size: 1.13em;
        font-weight: bold;
        letter-spacing: 0.5px;
        border: none;
        width: 100%;
        text-align: center;
      }
      .servico-edit-lista {
        margin-bottom: 12px;
      }
      .servico-edit-item {
        background: #222;
        border-radius: 10px;
        padding: 14px 14px 10px 14px;
        margin-bottom: 15px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        box-shadow: 0 1px 0 #333 inset;
        position: relative;
      }
      .servico-edit-nome {
        color: #00ff6a;
        font-weight: bold;
        font-size: 1.12em;
        margin-bottom: 2px;
        text-align: left;
        letter-spacing: 0.2px;
      }
      .servico-edit-preco {
        color: #fff;
        font-size: 1.04em;
        margin-bottom: 10px;
        text-align: left;
      }
      .remover-servico-btn {
        background: #ff5252;
        color: #fff;
        border: none;
        border-radius: 8px;
        padding: 10px 0;
        font-size: 1.07em;
        cursor: pointer;
        font-weight: bold;
        width: 100%;
        margin: 0;
        transition: background 0.18s;
        display: block;
      }
      .remover-servico-btn:hover {
        background: #c62828;
      }
      .adicionar-servico-bloco {
        background: #111;
        border-radius: 0 0 8px 8px;
        padding: 16px 8px 12px 8px;
        margin-bottom: 14px;
        border-bottom: 3px solid #00ff6a;
        box-shadow: 0 2px 0 #00ff6a inset;
        text-align: left;
      }
      .adicionar-servico-label {
        color: #00ff6a;
        font-size: 1.17em;
        font-weight: bold;
        margin-bottom: 7px;
        margin-left: 2px;
        letter-spacing: 0.2px;
      }
      .adicionar-servico-select {
        width: 100%;
        background: #fff;
        color: #111;
        border: 1.5px solid #222;
        border-radius: 6px;
        padding: 8px 7px;
        font-size: 1.07em;
        transition: border 0.18s;
        outline: none;
        margin-bottom: 0;
      }
      .adicionar-servico-select:focus {
        border: 1.5px solid #00ff6a;
      }
      .add-servico-btn {
        background: #00ff6a;
        color: #222;
        border: none;
        border-radius: 7px;
        padding: 12px 0;
        font-size: 1.12em;
        cursor: pointer;
        margin-top: 10px;
        margin-bottom: 10px;
        font-weight: bold;
        width: 100%;
        transition: background 0.18s, color 0.18s;
      }
      .add-servico-btn:hover {
        background: #009e46;
        color: #fff;
      }
      .salvar-btn {
        background: #fff;
        color: #222;
        border: none;
        border-radius: 7px;
        padding: 12px 0;
        font-size: 1.12em;
        cursor: pointer;
        margin-top: 6px;
        font-weight: bold;
        width: 100%;
        transition: background 0.18s, color 0.18s;
        box-shadow: 0 1px 0 #333 inset;
      }
      .salvar-btn:hover {
        background: #00c853;
        color: #fff;
      }
      .close-modal {
        position: absolute;
        right: 10px;
        top: 10px;
        color: #fff;
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.3em;
        padding: 0 8px;
        line-height: 1;
        border-radius: 50%;
        height: 32px;
        width: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: color 0.2s, background 0.2s;
      }
      .close-modal:hover {
        color: #00c853;
        background: rgba(0, 0, 0, 0.08);
      }
      .modal-msg {
        margin-top: 8px;
        font-size: 1em;
        color: #b2ff59;
        min-height: 18px;
      }
      @media (max-width: 500px) {
        .container {
          padding: 18px 2vw;
          width: 99vw;
        }
        .solicitacao-bloco {
          padding: 10px 7px;
          font-size: 1em;
        }
        .voltar-btn {
          padding: 8px 10px;
          font-size: 0.97em;
        }
        .modal-content {
          padding: 16px 4vw 12px 4vw;
          min-width: unset;
          max-width: 99vw;
        }
        .close-modal {
          font-size: 1em;
          height: 28px;
          width: 28px;
          right: 6px;
          top: 6px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <button class="voltar-btn" onclick="voltar()">
        <i class="fa fa-arrow-left"></i> Voltar
      </button>
      <h1>Minhas Solicitações</h1>
      <div class="solicitacoes-lista" id="solicitacoes-lista">
        <div style="color:#fff;text-align:center;">Carregando...</div>
      </div>
    </div>

    <!-- Modal Editar Solicitação -->
    <div class="modal" id="modalSolicitacao">
      <div class="modal-content">
        <button class="close-modal" onclick="fecharModalSolicitacao()" aria-label="Fechar">&times;</button>
        <div class="modal-title" id="modalSolicitacaoTitulo">Editar Solicitação</div>
        <div class="modal-status-label">Status</div>
        <div class="modal-status-value" id="statusSolicitacaoLabel"></div>
        <div id="servicosEdit" class="servico-edit-lista"></div>
        <div class="adicionar-servico-bloco">
          <div class="adicionar-servico-label">Adicionar serviço</div>
          <select id="selectAdicionarServico" class="adicionar-servico-select"></select>
        </div>
        <button class="add-servico-btn" onclick="adicionarServicoEdit()">+ Adicionar Serviço</button>
        <button class="salvar-btn" onclick="salvarSolicitacaoEditada()">Salvar Alteração</button>
        <div class="modal-msg" id="modalSolicitacaoMsg"></div>
      </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
    <script>
      const usuarioLogado = JSON.parse(localStorage.getItem("usuarioLogado"));
      if (!usuarioLogado) window.location.href = "index.html";

      const firebaseConfig = {
        apiKey: "AIzaSyAY-Win6vQEHP1XR_fG3NOg0PAkNPAcxSg",
        authDomain: "banco-de-dados-bd2a6.firebaseapp.com",
        projectId: "banco-de-dados-bd2a6",
        appId: "1:859895156791:web",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let listaSolicitacoes = [];
      let solicitacaoEditIdx = null;
      let servicosGlobais = [];

      function voltar() {
        window.history.back();
      }

      function formatarData(iso) {
        if (!iso) return '';
        const d = new Date(iso);
        return `${d.getDate().toString().padStart(2, '0')}/${
          (d.getMonth()+1).toString().padStart(2, '0')}/${
          d.getFullYear()} ${d.getHours().toString().padStart(2, '0')}:${
          d.getMinutes().toString().padStart(2, '0')}`;
      }

      function nomeParaId(nome) {
        return nome
          .normalize("NFD")
          .replace(/[\u0300-\u036f]/g, "")
          .replace(/[^a-zA-Z0-9]/g, "_");
      }

      function carregarServicosGlobais(callback) {
        db.collection("servicos").doc("servicos").get().then(doc => {
          if (doc.exists && Array.isArray(doc.data().lista)) {
            servicosGlobais = doc.data().lista;
          } else {
            servicosGlobais = [];
          }
          if (callback) callback();
        });
      }

      function carregarSolicitacoes() {
        const listaDiv = document.getElementById("solicitacoes-lista");
        listaDiv.innerHTML = '<div style="color:#fff;text-align:center;">Carregando...</div>';

        const meuDocId = nomeParaId(usuarioLogado.nome);

        carregarServicosGlobais(() => {
          db.collection("solicitacoes").doc(meuDocId).get().then(doc => {
            if (!doc.exists || !Array.isArray(doc.data().lista) || doc.data().lista.length === 0) {
              listaDiv.innerHTML = '<div style="color:#fff;text-align:center;">Nenhuma solicitação encontrada.</div>';
              return;
            }
            listaSolicitacoes = doc.data().lista;
            let html = `<div class="solicitacao-bloco">
              <div class="solicitacao-barbeiro"><i class="fa fa-user"></i> ${usuarioLogado.nome}</div>
              ${listaSolicitacoes.map((s, idx) => `
                <div class="solicitacao-item" onclick="abrirEditarSolicitacao(${idx})">
                  <div class="solicitacao-data"><i class="fa fa-calendar"></i> ${formatarData(s.dataCriacao)}</div>
                  <div class="solicitacao-servicos"><i class="fa fa-scissors"></i> 
                    ${Array.isArray(s.servicos) ? s.servicos.map(sv => `<b>${sv.nome}</b> <span style="color:#fff;">R$ ${sv.preco}</span>`).join(" ") : ""}
                  </div>
                  <div>Total: <b>R$ ${s.valorTotal}</b></div>
                  <div class="solicitacao-status solicitacao-${(s.status||'pendente').toLowerCase()}">
                    Status: ${s.status ? s.status.charAt(0).toUpperCase() + s.status.slice(1) : "Pendente"}
                  </div>
                </div>
              `).join("")}
            </div>`;
            listaDiv.innerHTML = html;
          }).catch(error => {
            listaDiv.innerHTML = '<div style="color:#ff5252;">Erro ao carregar solicitações: ' + error.message + '</div>';
          });
        });
      }

      function abrirEditarSolicitacao(idx) {
        solicitacaoEditIdx = idx;
        const s = listaSolicitacoes[idx];
        document.getElementById("modalSolicitacaoTitulo").textContent = "Editar Solicitação";
        document.getElementById("statusSolicitacaoLabel").textContent =
          s.status ? s.status.charAt(0).toUpperCase() + s.status.slice(1) : "Pendente";
        document.getElementById("modalSolicitacaoMsg").textContent = "";
        renderServicosEdit(s.servicos || []);
        renderSelectAdicionarServico(s.servicos || []);
        document.getElementById("modalSolicitacao").style.display = "flex";
      }

      function fecharModalSolicitacao() {
        document.getElementById("modalSolicitacao").style.display = "none";
      }

      function renderServicosEdit(servicos) {
        const div = document.getElementById("servicosEdit");
        let html = "";
        servicos.forEach((sv, idx) => {
          html += `
            <div class="servico-edit-item" data-idx="${idx}">
              <div class="servico-edit-nome">${sv.nome}</div>
              <div class="servico-edit-preco">R$ ${sv.preco}</div>
              <button type="button" class="remover-servico-btn" onclick="removerServicoEdit(${idx});event.stopPropagation();">Remover</button>
            </div>
          `;
        });
        div.innerHTML = html;
      }

      function renderSelectAdicionarServico(servicosAtuais) {
        const select = document.getElementById("selectAdicionarServico");
        select.innerHTML = "";
        const nomesAtuais = servicosAtuais.map(sv => sv.nome);
        servicosGlobais.forEach(sv => {
          if (!nomesAtuais.includes(sv.nome)) {
            const option = document.createElement("option");
            option.value = sv.nome;
            option.textContent = `${sv.nome} (R$ ${sv.preco})`;
            select.appendChild(option);
          }
        });
      }

      function adicionarServicoEdit() {
        if (solicitacaoEditIdx === null) return;
        const select = document.getElementById("selectAdicionarServico");
        const nomeServico = select.value;
        if (!nomeServico) return;
        const sv = servicosGlobais.find(sv => sv.nome === nomeServico);
        if (!sv) return;
        const s = listaSolicitacoes[solicitacaoEditIdx];
        if (!Array.isArray(s.servicos)) s.servicos = [];
        s.servicos.push({ nome: sv.nome, preco: sv.preco });
        renderServicosEdit(s.servicos);
        renderSelectAdicionarServico(s.servicos);
      }

      function removerServicoEdit(idx) {
        if (solicitacaoEditIdx === null) return;
        const s = listaSolicitacoes[solicitacaoEditIdx];
        if (!Array.isArray(s.servicos)) s.servicos = [];
        s.servicos.splice(idx, 1);
        renderServicosEdit(s.servicos);
        renderSelectAdicionarServico(s.servicos);
      }

      function salvarSolicitacaoEditada() {
        if (solicitacaoEditIdx === null) return;
        const msg = document.getElementById("modalSolicitacaoMsg");
        const s = listaSolicitacoes[solicitacaoEditIdx];
        // Valor total recalculado
        s.valorTotal = Array.isArray(s.servicos) ? s.servicos.reduce((acc, sv) => acc + sv.preco, 0) : 0;

        const meuDocId = nomeParaId(usuarioLogado.nome);
        db.collection("solicitacoes").doc(meuDocId).set({ lista: listaSolicitacoes })
          .then(() => {
            msg.textContent = "Solicitação atualizada!";
            msg.style.color = "#b2ff59";
            setTimeout(() => {
              fecharModalSolicitacao();
              carregarSolicitacoes();
            }, 800);
          })
          .catch(error => {
            msg.textContent = "Erro ao salvar: " + error.message;
            msg.style.color = "#ff5252";
          });
      }

      window.onload = carregarSolicitacoes;
      window.addEventListener("keydown", function (e) {
        if (e.key === "Escape") fecharModalSolicitacao();
      });
    </script>
  </body>
</html>
